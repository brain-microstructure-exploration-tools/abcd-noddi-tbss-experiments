#!/bin/bash
set -e

if [[ $# -ne 4 ]]; then
  echo "Usage: ./transform_to_template.sh <INPUT_DIR> <OUTPUT_DIR> <WARPS_DIR> <TEMPLATE>"
  echo "  where INPUT_DIR is the directory containing input images (possibly in subdirectories) to warp"
  echo "  and OUTPUT_DIR is the target directory in which to save the warped images"
  echo "  and WARPS_DIR is the directory containing the transformations saved by mrtrix3 population_template"
  echo "  and TEMPLATE is the path to the population template file generated by mrtrix3 population_template"
  exit
fi

INPUT_DIR=$1
OUTPUT_DIR=$2
WARPS_DIR=$3
TEMPLATE=$4

find "$INPUT_DIR" -type f -name "*.nii.gz" | while read -r FILE_IN; do
    FILE_OUT=$OUTPUT_DIR/${FILE_IN#*/}
    BASENAME= tr -d '\n' < <(sed 's/\(.*dwi\).*$/\1/' <(basename $FILE_IN .nii.gz))
    echo $BASENAME # TODO use the basename to now define the correct warp WARP in WARPS_DIR
    # TODO do the command: mrtransform $FILE_IN $FILE_OUT -warp $WARP -template $TEMPLATE
done